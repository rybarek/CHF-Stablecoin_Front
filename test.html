<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="main.css">
    <script type="text/javascript" src="./node_modules/web3/dist/web3.min.js"></script>
    <script type="text/javascript">

	const address = '0x1667FE801EE98Eb177f3357968e88073bb4A46A2';		

	const abi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "initialMessage",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "getMessage",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPrice_CHF_USD",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPrice_ETH_CHF",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPrice_ETH_USD",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "message",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "newMessage",
				"type": "string"
			}
		],
		"name": "setMessage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];


        window.addEventListener('load', function () {
		if (window.ethereum) {
			console.log("METAMASK");
		} else {
               	 	console.log('No Web3 Detected... using HTTP Provider')
              	  	window.web3 = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:7545"));
                    getCurrentAccount();
                    getMessage();
		}	
        })
        async function getBalance() {
            var address, wei, balance
            address = document.getElementById("address").value
            try {
                await web3.eth.getBalance(address, function (error, wei) {
                    if (!error) {
                        var balance = web3.utils.fromWei(wei, 'ether');
                        document.getElementById("output").innerHTML = balance + " ETH";
                    }
                });
            } catch (err) {
                document.getElementById("output").innerHTML = err;
            }
        }
	async function getCurrentAccount() {
            try {
	    	const accounts = await web3.eth.getAccounts();
            	var account = accounts[0];   
		document.getElementById("currentAccount").innerHTML = account;
	    } catch (err) {
                document.getElementById("currentAccount").innerHTML = err;
            }
        }

        async function getMessage() {

        try {
            var InboxContract = new web3.eth.Contract(abi, address); 
			const message = await InboxContract.methods.message().call();
		    document.getElementById("message").innerHTML = message;
	        } catch (err) {
                document.getElementById("message").innerHTML = err;
            }

        }
		async function updateMessage() {

		try {
			var InboxContract = new web3.eth.Contract(abi, address); 
			const accounts = await web3.eth.getAccounts();
            var account = accounts[0];  
			var newMessage  = document.getElementById("newMessage").value;
			await InboxContract.methods.setMessage(newMessage).send({ from: account});
			} catch (err) {
				document.getElementById("message").innerHTML = err;
			}
			getMessage();
		}
    </script>
</head>
<body>
    <h1>ETH Balance Fetcher</h1>
    <p>Curent Account: </p><div id="currentAccount"></div>
    <p>Enter your Ethereum Address:</p>
    <input type="text" size="50" id="address" />
    <button type="button" onClick="getBalance();">Get Balance</button>
    <br />
    <br />
    <div id="output"></div>
    <br />
    <p>Messagee : </p><div id="message"></div>
	<br />
	<input type="text" size="50" id="newMessage" />
    <button type="button" onClick="updateMessage();">Update Message</button>
</body>
</html>